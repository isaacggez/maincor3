<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Configurações - Perfil</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="p-4">
  <div style="max-width:720px;margin:0 auto;">
    <h2>Configurações</h2>

    <div class="card p-3 mb-3" style="display:flex;gap:12px;align-items:center;">
      <img id="cfg-avatar" src="/avatars/default-avatar.png" alt="avatar" style="width:96px;height:96px;border-radius:10px;object-fit:cover;">
      <div style="flex:1">
        <div id="cfg-nome" style="font-weight:700">Nome</div>
        <div id="cfg-email" class="text-muted">email</div>
        <div class="mt-2">
          <input type="file" id="cfg-avatar-file" accept="image/*">
          <button id="cfg-upload-avatar" class="btn btn-primary btn-sm">Salvar avatar</button>
        </div>
      </div>
    </div>

    <form id="form-perfil" class="card p-3 mb-3">
      <div class="mb-3">
        <label>Nome</label>
        <input id="input-nome" class="form-control" />
      </div>
      <div class="mb-3">
        <label>Senha (deixe em branco para não alterar)</label>
        <input id="input-senha" type="password" class="form-control" />
      </div>
      <div class="text-end">
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>

    <div id="cfg-msg" class="text-muted"></div>
  </div>

  <script src="js/api.js"></script>
  <script>
    (async function(){
      try {
        const perfil = await api.getMeuPerfil();
        document.getElementById("cfg-avatar").src = perfil.avatar_url || '/avatars/default-avatar.png';
        document.getElementById("cfg-nome").textContent = perfil.nome;
        document.getElementById("cfg-email").textContent = perfil.email;
        document.getElementById("input-nome").value = perfil.nome;
      } catch (e) { console.error(e); }

      document.getElementById("form-perfil").addEventListener("submit", async ev => {
        ev.preventDefault();
        const nome = document.getElementById("input-nome").value.trim();
        const senha = document.getElementById("input-senha").value;
        try {
          await api.atualizarMeuPerfil({ nome, senha: senha || undefined });
          document.getElementById("cfg-msg").textContent = "Perfil atualizado";
          document.getElementById("input-senha").value = "";
        } catch (err) {
          alert(err.message);
        }
      });

      document.getElementById("cfg-upload-avatar").addEventListener("click", async () => {
        const f = document.getElementById("cfg-avatar-file").files[0];
        if (!f) return alert("Selecione uma imagem");
        try {
          const res = await api.uploadMeuAvatar(f);
          document.getElementById("cfg-avatar").src = res.avatar_url + "?t=" + Date.now();
          alert("Avatar atualizado");
        } catch (err) {
          alert(err.message);
        }
      });
    })();
  </script>
</body>
</html>
