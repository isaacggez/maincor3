<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chamados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="page-dark">
  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="bg-dark text-white p-3 vh-100" style="width: 250px;">
      <h4 class="text-center">Painel</h4>
      <ul class="nav flex-column mt-4">
        <li class="nav-item"><a href="index.html" class="nav-link text-white">Início</a></li>
        <li class="nav-item"><a href="locais.html" class="nav-link text-white">Locais</a></li>
        <li class="nav-item"><a href="chamados.html" class="nav-link text-white active">Chamados</a></li>
        <li class="nav-item"><a href="novo-local.html" class="nav-link text-white">Novo Local</a></li>
        <li class="nav-item"><a href="config.html" class="nav-link text-white">Configurações</a></li>
        <li class="nav-item"><a href="login.html" class="nav-link text-danger">Sair</a></li>
      </ul>
    </nav>

    <!-- Conteúdo -->
    <main class="flex-grow-1 p-4">
      <h2>Chamados</h2>
      <table class="table table-striped mt-3">
        <thead>
          <tr>
            <th>ID</th>
            <th>Equipamento</th>
            <th>Problema</th>
            <th>Status</th>
            <th>Abertura</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>#1</td>
            <td>PC-01</td>
            <td>Não liga</td>
            <td><span class="badge bg-warning">Em andamento</span></td>
            <td>02/09/2025</td>
          </tr>
          <!-- Outras linhas -->
        </tbody>
      </table>
    </main>
  </div>
  <script>
(async function() {
  const tableBody = document.querySelector("table tbody");

  async function fetchChamados() {
    try {
      const res = await fetch("http://localhost:3001/chamados");
      if (!res.ok) throw new Error("Erro ao buscar chamados");
      const chamados = await res.json();
      renderTable(chamados);
    } catch (err) {
      alert(err.message);
    }
  }

  function renderTable(chamados) {
    tableBody.innerHTML = "";
    if (!chamados.length) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Nenhum chamado encontrado.</td></tr>`;
      return;
    }
    chamados.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>#${c.id_chamado || c.id}</td>
        <td>${c.equipamento_nome || c.id_equipamento}</td>
        <td>${c.categoria_nome || c.categoria || "Não informado"}</td>
        <td><span class="badge ${c.status === "aberto" ? "bg-warning" : c.status === "resolvido" ? "bg-success" : "bg-secondary"}">
            ${c.status}
        </span></td>
        <td>${c.data_abertura ? new Date(c.data_abertura).toLocaleDateString() : "-"}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  await fetchChamados();
})();
</script>

<!-- MODAL: Histórico / Responder Chamado -->
<div class="modal fade" id="modalHistorico" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="hist-title">Histórico</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="hist-list" class="mb-3"></div>
        <hr>
        <form id="form-responder">
          <div class="mb-3">
            <label class="form-label">Responder</label>
            <textarea id="resposta-text" class="form-control" rows="3" placeholder="Escreva sua resposta..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Alterar status (opcional)</label>
            <select id="resposta-status" class="form-select">
              <option value="">-- manter --</option>
              <option value="em_andamento">Em andamento</option>
              <option value="resolvido">Resolvido</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>
          <input type="hidden" id="resposta-id">
          <div class="text-end">
            <button type="submit" class="btn btn-primary">Enviar resposta</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS do Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/ui.js"></script>
<script src="js/chamados.js"></script>
</body>
</html>
